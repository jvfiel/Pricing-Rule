[
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "Sales Invoice", 
  "modified": "2019-09-14 10:01:48.893859", 
  "name": "Sales Invoice-Client", 
  "parent": null, 
  "parentfield": null, 
  "parenttype": null, 
  "script": "function isEmpty(obj) {\n    for(var key in obj) {\n        if(obj.hasOwnProperty(key))\n            return false;\n    }\n    return true;\n}\n\nfrappe.ui.form.on(\"Sales Invoice Item\", \"item_code\", function(doc,cdt,cdn){\n     let row = frappe.get_doc(cdt, cdn);\n    if(row.item_code) {\n        frappe.call({\n            method: \"pricing_rule.pricing_rule.filter_uom\",\n            args: {\n                item: row.item_code\n            },\n            callback: function (data) {\n                if (data.message) {\n                    var options = data.message;\n                    console.log(data.message.length);\n                    console.log(\"options.join:\" + options.join(\"\\n\"));\n                    var options_new = options.join(\"\\n\");\n\n                    // var df = frappe.meta.get_docfield('Show Hide Desktop Icons','icon', cur_frm.doc.name);\n                    // \t\t// console.log(df);\n                    // \t\tdf.options = r.message;\n                    console.log(options_new);\n                    frappe.meta.get_docfield(\"Sales Invoice Item\", \"uom_select\", cur_frm.doc.name).options = options_new;\n                    refresh_field(\"items\");\n                }\n            }\n        });\n    }\n});\n\n\nfrappe.ui.form.on(\"Sales Invoice Item\", {\n\n    uom_select:function(doc,cdt,cdn)\n    {\n        let row = frappe.get_doc(cdt, cdn);\n        row.uom = row.uom_select;\n\n\n         if(row.item_code && row.uom)\n         {\n\n              frappe.call({\n                  method: \"pricing_rule.pricing_rule.filter_uom_rate\",\n                  args: {\n                      item: row.item_code,\n                      uom:row.uom\n                  },\n                  async:false,\n                  callback: function (data) {\n                      if (data.message) {\n\n                            frappe.call({\n                                method: \"pricing_rule.pricing_rule.get_price\",\n                                args: {\n                                    item_code: row.item_code,\n                                    price_list: cur_frm.doc.selling_price_list\n                                },\n                                async: false,\n                                callback: function (price_list) {\n                                        console.log(price_list);\n                                       frappe.call({\n                                        method: \"pricing_rule.pricing_rule.get_pricing\",\n                                        args: {\n                                            item: row.item_code,\n                                            uom: row.uom,\n                                            pricelist:cur_frm.doc.selling_price_list\n                                        },\n                                        async:false,\n                                        callback: function (r) {\n                                            if(!isEmpty(r.message)) {\n                                            // row.margin_type = \"Percentage\";\n                                            // row.discount_percentage = r.message[0].discount_percentage;\n                                             console.log(r.message[0].name);\n                                            row.pricing_rule = r.message[0].name;\n                                            console.log(r.message[0].discount_percentage);\n                                            row.discount_percentage = r.message[0].discount_percentage;\n\n                                                  var options = data.message;\n                                                  console.log(options);\n                                                  row.conversion_factor =options;\n                                                   row.stock_qty = row.conversion_factor;\n                                                    row.price_list_rate = price_list.message.price_list_rate*row.conversion_factor;\n                                                  // row.rate = row.price_list_rate;\n                                                  // row.rate = row.price_list_rate*row.conversion_factor;\n                                                  row.rate = row.price_list_rate;\n                                                  // console.log(\"-------------------------------\");\n                                                  // console.log(((row.price_list_rate*row.conversion_factor) * row.qty));\n                                                  // console.log((((row.price_list_rate*row.conversion_factor) * row.qty) * (row.discount_percentage/100)));\n                                                  // row.discount_amount = (((row.price_list_rate*row.conversion_factor) * row.qty) * (row.discount_percentage/100));\n                                                  row.discount_amount = ((row.price_list_rate * row.qty) * (row.discount_percentage/100));\n                                                  // row.amount = (row.rate * row.qty) - (((row.price_list_rate*row.conversion_factor) * row.qty) * (row.discount_percentage/100));\n                                                  row.amount = (row.rate * row.qty) - ((row.price_list_rate * row.qty) * (row.discount_percentage/100));\n\n\n                                        }\n                                        else {\n                                            row.pricing_rule = \"\";\n                                            frappe.msgprint(\"no Princing Rule found.\");\n                                                   row.discount_percentage = 0.00;\n\n                                                  var options = data.message;\n                                                  console.log(options);\n                                                  row.conversion_factor =options;\n                                                   row.stock_qty = row.conversion_factor;\n                                                    row.price_list_rate = price_list.message.price_list_rate*row.conversion_factor;\n                                                  // row.rate = row.price_list_rate;\n                                                  // row.rate = row.price_list_rate*row.conversion_factor;\n                                                  row.rate = row.price_list_rate;\n                                                  // console.log(\"-------------------------------\");\n                                                  // console.log(((row.price_list_rate*row.conversion_factor) * row.qty));\n                                                  // console.log((((row.price_list_rate*row.conversion_factor) * row.qty) * (row.discount_percentage/100)));\n                                                  // row.discount_amount = (((row.price_list_rate*row.conversion_factor) * row.qty) * (row.discount_percentage/100));\n                                                  row.discount_amount = ((row.price_list_rate * row.qty) * (row.discount_percentage/100));\n                                                  // row.amount = (row.rate * row.qty) - (((row.price_list_rate*row.conversion_factor) * row.qty) * (row.discount_percentage/100));\n                                                  row.amount = (row.rate * row.qty) - ((row.price_list_rate * row.qty) * (row.discount_percentage/100));\n\n                                        }\n                                        refresh_field(\"items\");\n                                }\n                            });\n                                }\n                            })\n\n\n                      }\n                  }\n              });\n\n\n        }\n\n        refresh_field(\"items\");\n    },\n    item_code: function (doc, cdt, cdn) {\n          let me = this;\n        let row = frappe.get_doc(cdt, cdn);\n        row.uom_select = row.stock_uom;\n        row.uom = row.stock_uom;\n\n\n        console.log(\"pricing rule**\");\n        console.log(row);\n\n        if(row.item_code && row.uom) {\n            frappe.call({\n                method: \"pricing_rule.pricing_rule.get_pricing\",\n                args: {\n                    item: row.item_code,\n                    uom: row.uom,\n                    pricelist:cur_frm.doc.selling_price_list\n                },\n                callback: function (r) {\n                        if(!isEmpty(r.message)) {\n                            // row.margin_type = \"Percentage\";\n                            // row.discount_percentage = r.message[0].discount_percentage;\n                            console.log(r.message[0].name);\n                            row.pricing_rule = r.message[0].name;\n                            console.log(r.message[0].discount_percentage);\n                            row.discount_percentage = r.message[0].discount_percentage;\n\n\n                        }\n                        else {\n                            row.pricing_rule = \"\";\n                            frappe.msgprint(\"no Princing Rule found.\");\n                        }\n                        refresh_field(\"items\");\n                }\n            });\n        }\n    }\n});", 
  "script_type": "Client"
 }, 
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "Sales Order", 
  "modified": "2019-09-08 12:23:09.954157", 
  "name": "Sales Order-Client", 
  "parent": null, 
  "parentfield": null, 
  "parenttype": null, 
  "script": "function isEmpty(obj) {\n    for(var key in obj) {\n        if(obj.hasOwnProperty(key))\n            return false;\n    }\n    return true;\n}\n\nfrappe.ui.form.on(\"Sales Order Item\", \"item_code\", function(doc,cdt,cdn){\n     let row = frappe.get_doc(cdt, cdn);\n    if(row.item_code) {\n        frappe.call({\n            method: \"pricing_rule.pricing_rule.filter_uom\",\n            args: {\n                item: row.item_code\n            },\n            callback: function (data) {\n                if (data.message) {\n                    var options = data.message;\n                    console.log(data.message.length);\n                    console.log(\"options.join:\" + options.join(\"\\n\"));\n                    var options_new = options.join(\"\\n\");\n\n                    // var df = frappe.meta.get_docfield('Show Hide Desktop Icons','icon', cur_frm.doc.name);\n                    // \t\t// console.log(df);\n                    // \t\tdf.options = r.message;\n                    console.log(options_new);\n                    frappe.meta.get_docfield(\"Sales Order Item\", \"uom_select\", cur_frm.doc.name).options = options_new\n                    refresh_field(\"items\");\n                }\n            }\n        });\n    }\n});\n\n\nfrappe.ui.form.on(\"Sales Order Item\", {\n\n    uom_select:function(doc,cdt,cdn)\n    {\n        let row = frappe.get_doc(cdt, cdn);\n        row.uom = row.uom_select;\n\n         if(row.item_code && row.uom) {\n            frappe.call({\n                method: \"pricing_rule.pricing_rule.get_pricing\",\n                args: {\n                    item: row.item_code,\n                    uom: row.uom,\n                    pricelist:cur_frm.doc.selling_price_list\n                },\n                callback: function (r) {\n                        if(!isEmpty(r.message)) {\n                            // row.margin_type = \"Percentage\";\n                            // row.discount_percentage = r.message[0].discount_percentage;\n                             console.log(r.message[0].name);\n                            row.pricing_rule = r.message[0].name;\n                            console.log(r.message[0].discount_percentage);\n                            row.discount_percentage = r.message[0].discount_percentage;\n\n                        }\n                        else {\n                            row.pricing_rule = \"\";\n                            frappe.msgprint(\"no Princing Rule found.\");\n                        }\n                        refresh_field(\"items\");\n                }\n            });\n        }\n\n        refresh_field(\"items\");\n    },\n    item_code: function (doc, cdt, cdn) {\n          let me = this;\n        let row = frappe.get_doc(cdt, cdn);\n\n        // console.log(row.item_code);\n        // cur_frm.fields_dict.items.grid.get_field('uom').get_query =\n        // function() {\n        //     return {\n        //\n        //         query: \"pricing_rule.pricing_rule.filter_uom\",\n        //     filters: {\n        //         \"item\":row.item_code\n        //     }\n        //     }\n        // };\n\n\n\n        console.log(\"pricing rule**\");\n        console.log(row);\n\n        if(row.item_code && row.uom) {\n            frappe.call({\n                method: \"pricing_rule.pricing_rule.get_pricing\",\n                args: {\n                    item: row.item_code,\n                    uom: row.uom,\n                    pricelist:cur_frm.doc.selling_price_list\n                },\n                callback: function (r) {\n                        if(!isEmpty(r.message)) {\n                            // row.margin_type = \"Percentage\";\n                            // row.discount_percentage = r.message[0].discount_percentage;\n                            console.log(r.message[0].name);\n                            row.pricing_rule = r.message[0].name;\n                            console.log(r.message[0].discount_percentage);\n                            row.discount_percentage = r.message[0].discount_percentage;\n                        }\n                        else {\n                            row.pricing_rule = \"\";\n                            frappe.msgprint(\"no Princing Rule found.\");\n                        }\n                        refresh_field(\"items\");\n                }\n            });\n        }\n    }\n    ,\n    uom: function (doc, cdt, cdn) {\n          let me = this;\n        let row = frappe.get_doc(cdt, cdn);\n        console.log(\"pricing rule**\");\n        console.log(row);\n\n            if (row.item_code && row.uom) {\n                frappe.call({\n                    method: \"pricing_rule.pricing_rule.get_pricing\",\n                    args: {\n                        item: row.item_code,\n                        uom: row.uom,\n                        pricelist:cur_frm.doc.selling_price_list\n                    },\n                    callback: function (r) {\n                        console.log(r);\n                        if(!isEmpty(r.message)) {\n                            // row.margin_type = \"Percentage\";\n                            // row.discount_percentage = r.message[0].discount_percentage;\n                            console.log(r.message[0].name);\n                            row.pricing_rule = r.message[0].name;\n                            console.log(r.message[0].discount_percentage);\n                            row.discount_percentage = r.message[0].discount_percentage;\n                        }\n                        else {\n                            row.pricing_rule = \"\";\n                            frappe.msgprint(\"no Princing Rule found.\");\n                        }\n                        refresh_field(\"items\");\n                    }\n                });\n            }\n    }\n});", 
  "script_type": "Client"
 }
]